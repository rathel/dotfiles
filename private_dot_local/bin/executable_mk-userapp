#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
mk-userapp - create GNOME-style userapp-*.desktop launchers.

USAGE:
  mk-userapp -e /path/to/exe [-n "Name"] [-i icon] [-m mime1,mime2,...]
             [-c "Categories;"] [--terminal] [--uris] [--no-defaults]

FLAGS:
  -e|--exec        Absolute or relative path to the executable (required)
  -n|--name        Display name (default: derived from executable basename)
  -i|--icon        Icon name or absolute path to an image (PNG/SVG). If a file
                   path is given, we use it directly; otherwise we set Icon=<name>.
  -m|--mime        Comma-separated list of MIME types or x-scheme-handlers
                   (e.g. text/plain,image/png,x-scheme-handler/magnet)
  -c|--categories  Semicolon-separated Categories (default: "Utility;")
  --terminal       Run in a terminal (default: false)
  --uris           Use %U (URIs) instead of %F (files)
  --no-defaults    Do NOT set this launcher as default for provided MIME types
  -h|--help        Show this help

NOTES:
  - Creates: ~/.local/share/applications/userapp-<name>-<rand>.desktop
  - Calls:   update-desktop-database (if available)
  - If -m is given and --no-defaults is NOT used, sets this userapp as the default:
             xdg-mime default <desktop> <mime>
EOF
}

# --- parse args ---
exec_path="" ; name="" ; icon="" ; mime_csv="" ; categories="Utility;"
terminal=false ; use_uris=false ; set_defaults=true
while (( "$#" )); do
  case "$1" in
    -e|--exec)       exec_path="$2"; shift 2;;
    -n|--name)       name="$2"; shift 2;;
    -i|--icon)       icon="$2"; shift 2;;
    -m|--mime)       mime_csv="$2"; shift 2;;
    -c|--categories) categories="$2"; shift 2;;
    --terminal)      terminal=true; shift;;
    --uris)          use_uris=true; shift;;
    --no-defaults)   set_defaults=false; shift;;
    -h|--help)       usage; exit 0;;
    *) echo "Unknown arg: $1"; usage; exit 1;;
  esac
done

[[ -z "${exec_path}" ]] && { echo "Error: --exec is required."; usage; exit 1; }

# Normalize paths and defaults
exec_path="$(readlink -f "${exec_path}")"
[[ -x "${exec_path}" ]] || { echo "Error: ${exec_path} is not executable."; exit 1; }

base="$(basename "${exec_path}")"
[[ -z "${name}" ]] && name="$(tr '[:lower:]' '[:upper:]' <<<"${base:0:1}")${base:1}"

rand="$(tr -dc a-z0-9 </dev/urandom | head -c 6)"
deskdir="${HOME}/.local/share/applications"
mkdir -p "${deskdir}"

desktop_id="userapp-${base}-${rand}.desktop"
desktop_path="${deskdir}/${desktop_id}"

# Exec field placeholder
placeholder="%F"
$use_uris && placeholder="%U"

# Icon handling: if a file path, use absolute path; else treat as theme name (or empty)
icon_line=""
if [[ -n "${icon}" ]]; then
  if [[ -f "${icon}" ]]; then
    icon_line="Icon=$(readlink -f "${icon}")"
  else
    icon_line="Icon=${icon}"
  fi
fi

terminal_val="$($terminal && echo true || echo false)"

# MimeType line
mime_line=""
if [[ -n "${mime_csv}" ]]; then
  # normalize commas -> semicolon list with trailing semicolon per spec
  mime_norm="$(echo "${mime_csv}" | tr ',' ';')"
  [[ "${mime_norm}" != *';' ]] && mime_norm="${mime_norm};"
  mime_line="MimeType=${mime_norm}"
fi

# Write desktop file
cat > "${desktop_path}" <<EOF
[Desktop Entry]
Type=Application
Name=${name}
Exec=${exec_path} ${placeholder}
${icon_line}
Terminal=${terminal_val}
Categories=${categories}
${mime_line}
EOF

# Validate / install (optional)
if command -v desktop-file-validate >/dev/null 2>&1; then
  desktop-file-validate "${desktop_path}" || true
fi
if command -v update-desktop-database >/dev/null 2>&1; then
  update-desktop-database "${deskdir}" >/dev/null 2>&1 || true
fi

# Set as default handler for each MIME (unless skipped)
if [[ -n "${mime_csv}" && "${set_defaults}" = true ]]; then
  IFS=',' read -r -a mimes <<< "${mime_csv}"
  for m in "${mimes[@]}"; do
    m_trim="$(echo "$m" | xargs)"
    [[ -n "${m_trim}" ]] && xdg-mime default "${desktop_id}" "${m_trim}"
  done
fi

echo "Created: ${desktop_path}"
if [[ -n "${mime_csv}" && "${set_defaults}" = true ]]; then
  echo "Set as default for: ${mime_csv}"
fi

